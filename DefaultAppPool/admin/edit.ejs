<% 
const session = LightBlog.getSession(response, request);

if (!session)
{
    response.redirect(LightBlog.INDEX_PATH, true, false);
    return "";
}

////////////////////////////////////////////////

const post = LightBlog.getPost(request.getQueryString(), true);

if (!post) 
{
    response.redirect(LightBlog.DASHBOARD_PATH, true, false); 
    return "";
}

%> 
<!DOCTYPE html>  
<html> 
    <head>  
        <title><%= post.title %> - LightBlog</title>

        <link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
        <link href="/admin.css" rel="stylesheet" media="screen">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abhaya+Libre" media="all" onload="if(media!='all')media='all'">

        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>         
    <body> 
        <div class="topbar">
            <a href="index">Control Panel</a> / <a><%= post.title %></a>
        </div>
        <div id="form-ext">  
            <div class="form-group">
                <div class="form-group-header">
                    <label>ID</label> 
                </div>
                <div class="form-group-body">
                    <input class="form-control disabled" id="post-id" disabled type="text" value="<%= post.id %>" />
                </div>
            </div>
            
            <div class="form-group">
                <div class="form-group-header">
                    <label>Creation Date</label> 
                </div>
                <div class="form-group-body">
                    <input class="form-control disabled" disabled type="text" value="<%= post.date %>" />
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-header">
                    <label>Last Edit Date</label> 
                </div>
                <div class="form-group-body">
                    <input class="form-control disabled" disabled id="last-edit-date" type="text" value="<%= post.editDate %>" />
                </div>
            </div>

            <!--------------------------------------------------------->

            <div class="form-group">
                <div class="form-group-header">
                    <label>Title</label>
                    <span class="info-span" id="info-title"></span>
                </div>
                <div class="form-group-body">
                    <input class="form-control" type="text" value="<%= post.title %>" id="title" />
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-header">
                    <label>Cover Photo (url)</label>
                    <span class="info-span" id="info-cover-photo"></span>
                </div>
                <div class="form-group-body">
                    <input class="form-control" type="text" value="<%= post.coverPhoto %>" id="cover-photo" />
                </div>

                <div style="background-image:url('<%= post.coverPhoto %>')" id="cover-photo-preview" class="form-image-preview"></div>
            </div>

            <div class="form-group">
                <div class="form-group-header">
                    <label>Preview Content (autosaves)</label>
                    <span class="info-span" id="info-preview-content"></span>
                </div>
                <div class="form-group-body">
                    <textarea rows="8" cols="90" id="preview-content"><%= post.previewContent %></textarea>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-header">
                    <label>Content (autosaves)</label>
                    <span class="info-span" id="info-content"></span>
                </div>
                <div class="form-group-body">
                    <textarea rows="8" cols="90" id="content"><%= post.content %></textarea>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-body">
                    <div class="form-checkbox">
                        <input type="checkbox" <% if (post.isHidden) { %><%= "checked" %><% } %> id="hidden" />
                            Hidden
                        </label>
                        <p class="note">
                            Enabling this will <strong>hide</strong> the post from the public!
                        </p>
                    </div>
                </div>
            </div> 
            
            <div class="form-group" style="padding-top: 22px;margin-top: 25px;border-top: 1px solid #c5c5c5;">
                <div class="form-group-body">
                    <details>
                        <summary class="btn btn-danger">Delete</summary>
                        <div class="border p-3 mt-2">
                            <label>Enter the title of the post to delete.</label><br><br>
                            <input class="form-control" type="text" id="delete-title" /><br><br>
                            <button type="button" id="submit" class="btn btn-danger" >Delete</button>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    
        <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
        <script>
            var previewContent = new SimpleMDE({ element: document.getElementById("preview-content"), autosave: { enabled: true } });
            var content = new SimpleMDE({ element: document.getElementById("content"), autosave: { enabled: true } });
            let contentInputTimeout;

            content.codemirror.on("change", () =>
            {
                document.getElementById("info-content").textContent = "Saving...";
                document.getElementById("info-content").style = "";

                if (contentInputTimeout)
                    clearTimeout(contentInputTimeout);

                contentInputTimeout = setTimeout(() => {
                    fetch("/admin/update/post", { 
                        method: "POST",
                        body: JSON.stringify({
                            "id": document.getElementById("post-id").value,
                            "content": content.value()
                        })
                    }) 
                    .then(response => response.json())
                    .then((data) => 
                    {
                        if (data.success) 
                        {
                            document.getElementById("info-content").textContent = "Autosaved! " + new Date().toString();
                        }
                        else
                        {
                            document.getElementById("info-content").textContent = "Failed to autosave!";
                            document.getElementById("info-content").style = "color:red;";
                        }
                    });
                }, 500);
            });

            previewContent.codemirror.on("change", () =>
            {
                document.getElementById("info-preview-content").textContent = "Saving...";
                document.getElementById("info-preview-content").style = "";

                if (contentInputTimeout)
                    clearTimeout(contentInputTimeout);

                contentInputTimeout = setTimeout(() => {
                    fetch("/admin/update/post", { 
                        method: "POST",
                        body: JSON.stringify({
                            "id": document.getElementById("post-id").value,
                            "previewContent": previewContent.value()
                        })
                    }) 
                    .then(response => response.json())
                    .then((data) => 
                    {
                        if (data.success) 
                        {
                            document.getElementById("info-preview-content").textContent = "Autosaved! " + new Date().toString();
                        }
                        else
                        {
                            document.getElementById("info-preview-content").textContent = "Failed to autosave!";
                            document.getElementById("info-preview-content").style = "color:red;";
                        }
                    });
                }, 500);
            });
        </script>

    </body>
</html>   